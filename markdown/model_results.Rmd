---
title: "Modeling of the Impact of Temperature and Urchins on Kelp Percent Cover"
author: "Jarrett Byrnes"
date: "5/28/2021"
output: 
    html_document:
        toc: true
        toc_float: true
        toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = here::here())
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

## The Model

To understand the causal effect of temperature and urchins on percent cover of kelp in different regions in Maine, we fit a generalized linear mixed effects model with a beta error distribution and a complementary log-log link function. These models are ideal for modeling percent cover data (DIRCHLET PAPER FROM MEE), as they naturally allow for a 0/100% boundary. The complementary log-log curve is also ideal as, unlike logit or probit links, it is not symmetrical and is steep as cover approaches 100%, a property ideal for the type of hysteresis generated by urchins (Appendix I shows that it also outperforms logit and probit links for this dataset). As spatial gradients in temperature and urchin abundance could be correlated with other regional drivers - e.g., urbanization, riverine inputs, recruitment, nutrients, etc. - and we were interested in estimating a causal estimate of these two drivers, we employed a group mean centering approach taken from econometrics (REFS). The linear portion of our model structure was thus as follows for kelp percent cover p in replicate i at site j and year k where f(x) is the complementary log-log function:

$f(p_{ijk}) ~ \bar t_j + \Delta t_{jk} + \bar u_j + \Delta u_{ijk} + \delta_j + \delta_k$

Here $\bar t_j$ is the regional mean temperature over the time series and $\Delta t_{ik}$ is the anomoly in the region in year k. The same technique is applied to urchins (u). However, we calculate the anomoly for urchins in plots i in region j and year k. In this model, the group mean effects control for drivers correlated with either urchins or temperature at the regional scale. The causal signal of urchins or temperature is contained in the anomolies from regional means. Finally, the above model contains a random effect of region, $\delta_j$, and year, $delta_k$, which are both distributed $\mathcal{N}(0, \tau)$ where $\tau$ is a standard deviation. These random effects to account for random variability due to drivers not correlated with either temperature or urchins. For a deeper exploration of this model structure and how it is used in econometrics, see Bell et al. (DATE). We evaluated model assumptions of uniform distribution of quantile residuals (DHARMa) as well as checking for multicollinearity and distribution of random effects.

We evaluated the above model and a model where the urchin and temperature anomoly were allowed to interact. We compared these two models with Akaike's Information Criteria (AIC, B&A ref) to see which has better predictive performance (Aho ref).

## Model Results

```{r load_model, include = FALSE, echo = FALSE}

library(ggplot2)
library(modelr)
library(dplyr)
library(tidyr)
library(glmmTMB)
library(here) # paths to data should 'just work' (though having problems with it)
library(readr)
library(DHARMa) # Residual diagnostics for hierarchal regression models
library(bbmle) #for AICtab
library(gtsummary)

theme_set(theme_classic())


DF.join <- read_csv("derived_data/combined_data_for_analysis.csv")
mod_urchin_add <- readRDS("derived_data/mod_urchin_add.RDS")
mod_urchin_int <- readRDS("derived_data/mod_urchin_int.RDS")

DF_means <- DF.join %>%
   group_by(region) %>%
    dplyr::summarize(mean_temp_mn = mean_temp_mn[1],
              urchin_mn = urchin_mn[1],
              max_temp_mn = max_temp_mn[1],
              stress.temp_mn = stress.temp_mn[1]) %>%
    ungroup()

```

Both the additive and non-additive model meet all assumptions (additive model results shown).

```{r dharma, fig.cap="QQ Plot of Quantile Residuals"}
simulateResiduals(mod_urchin_add) %>% plotQQunif()
```

```{r assume, fig.cap="Other assumption checks"}
performance::check_model(mod_urchin_add)
```

The additive and non-additive model produce roughly the same results (small $\Delta$AIC). The principle of parsimony suggests using the additive model.

```{r aic}
AICtab(mod_urchin_add, mod_urchin_int)
```

$\chi^2$ likelihood ratio tests show that the temperature anomaly effect is supported as being different from zero.

```{r anova}
car::Anova(mod_urchin_add) %>% pander::pander()
```

Where both urchin and temperature anomoly have negative effects on kelp. Cooler regions also have more kelp, but, this could be temperature effects *per se* or other factors correlated with temperature.

```{r summary}
mod_urchin_add %>% sjPlot::tab_model(transform = NULL)
```

## Additive versus non-additive

The additive and non-additive model have very similar predictive abilities, and thus the principle of parsimony suggests using the additive only model. 

```{r compare_nonadd}
AICtab(mod_urchin_add, mod_urchin_int)
```


## Fit of the Model to Data
The model fits the data fairly well with an R2 as follows.

```{r r2}
performance::r2_nakagawa(mod_urchin_add_logit)
```

If we plot the fixed effects of the model with the data, we can see that we capture trends fairly well.

```{r mod_fit}
fit_df <- DF.join %>%
    filter(!is.na(urchin)) %>%
    group_by(region, year) %>%
    summarize_all(mean, na.rm = TRUE) %>%
    ungroup()

fit_values <- predict(mod_urchin_add, 
                           newdata = fit_df, 
                           re.form = NULL, 
                           type = "response",
                           se.fit = TRUE)

fit_df <- fit_df %>%
    mutate(kelp.perc_raw = kelp.perc,
           kelp.perc = fit_values$fit,
           lwr = kelp.perc - 1*fit_values$se.fit,
           upr = kelp.perc + 1*fit_values$se.fit,
           lwr = ifelse(lwr < 0, 0, lwr))



# all regions
ggplot(fit_df %>% 
           mutate(region = stringr::str_to_title(region)),
       aes(x = year,
           y = kelp.perc*100,
           group = region)) +
        geom_ribbon(aes(ymin = lwr*100, ymax = upr*100), alpha = 0.7, color = NA, fill = "grey") +
    geom_line(size = 1.5) +

    theme_bw() +
    labs(color = "",
         x = "",
         y = "Percent Cover Kelp") +
    geom_point(aes(y = kelp.perc_raw*100), size = 2) +
    facet_wrap(~region)
```

## Model Heatmaps

We can look at the implications of our model in a number of ways. For example, if we compare how kelp will change given temperature change as we move from Downeast to York. The effects of urchins and temperature change because of the background conditions of each region.

```{r}
source("scripts/make_kelp_heatmap.R")

make_kelp_heatmap_regional <- function(a_region){
   make_kelp_heatmap(urchin_mn = DF_means %>% filter(region==a_region) %>% pull(urchin_mn),
                  mean_temp_mn = DF_means %>% filter(region==a_region) %>% pull(mean_temp_mn)) +
    labs(subtitle = stringr::str_to_title(a_region)) 
}


make_kelp_heatmap_regional("downeast")
make_kelp_heatmap_regional("penbay")
make_kelp_heatmap_regional("york")

```

## How does Temperature Affect Regions in Different Ways at Different Urchin Densities

One way to explore the implication of our model is to evaluate how the different regions will respond to changing absolute temperatures given their current state and at different levels of urchins.  In this figure, temperature is a combination of regional mean as well as deviation from mean (e.g., we took a temperature, and calculated the anomoly as difference of that temperature from regional mean). You can see that the impact of temperature differs by regions, even though the impact of urchins is similar.

```{r york_downeast}

pred_frame <- crossing(DF_means,
         urchin  = c(0,80),
                temp = seq(11, 18, length.out = 100),
         year = 2015) %>%
    mutate(mean_temp_dev = temp - mean_temp_mn,
           urchin_dev = urchin - urchin_mn)

pred_values <- predict(mod_urchin_add, 
                                newdata = pred_frame, 
                                re.form = NULL, 
                                type = "response",
                                se.fit = TRUE)

pred_frame <- pred_frame %>%
    mutate(kelp.perc = pred_values$fit,
           lwr = kelp.perc - 1*pred_values$se.fit,
           upr = kelp.perc + 1*pred_values$se.fit,
           lwr = ifelse(lwr < 0, 0, lwr))

#york v. downeast
ggplot(pred_frame %>% 
           filter(region %in% c("downeast", "york")) %>%
           mutate(urchin = paste0(urchin, " urchins"),
                  region = stringr::str_to_title(region)),
       aes(x = temp,
           y = kelp.perc*100,
           group = region, 
           color = region)) +
    geom_line(size = 2) +
    geom_ribbon(aes(ymin = lwr*100, ymax = upr*100), alpha = 0.2, color = NA, fill = "grey") +
    facet_wrap(~urchin, ncol = 1) +
    scale_color_manual(values = c("blue", "red")) +
    theme_bw() +
    labs(color = "",
         x = "Temperature C",
         y = "Percent Cover Kelp")
```

## Scenarios of Change

Change in urchin abundance and temperature are correlated in the timeseries. While our model teases them apart, to understand how our model predicts the world should change over time as both drivers change, we can construct a scenario to map out change. To understand how the correlated change should affect different regions, we built a scenario where urchins anomoly decreases by 7% every year. Meanwhile, temperature rises by 0.07 degrees per year, with an anomoly going from -0.595 to 0.595, as in the average of the data.


```{r build_scenario}
anom_df <- data.frame(
    year = 2001:2018,
    mean_temp_dev = seq(.07*8.5*-1, .07*8.5,  by = 0.07),
    urchin = 20*exp(-0.07*1:18) 
)


scenario_sim <- tidyr::crossing(anom_df, DF_means) %>%
    mutate(urchin_dev = urchin - urchin_mn)

scenario_sim_values <- predict(mod_urchin_add, 
                                newdata = scenario_sim , 
                                re.form = NULL, 
                                type = "response",
                                se.fit = TRUE)

scenario_sim <- scenario_sim %>%
    mutate(kelp.perc = scenario_sim_values$fit,
           lwr = kelp.perc - 1*scenario_sim_values$se.fit,
           upr = kelp.perc + 1*scenario_sim_values$se.fit,
           lwr = ifelse(lwr < 0, 0, lwr)) 

ggplot(scenario_sim,
       aes(x = year, y = kelp.perc*100, ymin = lwr*100, ymax = upr*100, 
           color = region, group = region)) +
        geom_line(size = 2) +
    geom_ribbon(alpha = 0.2, color = NA, fill = "grey") +
    labs(color = "",
         x = "",
         y = "Percent Cover Kelp")

```


We can contrast this to how things played out in the data. Here, we use the scenario of taking the average temperature anomoly and average urchin anomoly and plot the resulting kelp abundances by year as predicted by the model. We see this reproduces similar dynamics to the raw data - temperature impact varies by region, even though urchins are in decline.

```{r scenario_data}
timeseries_df <- DF.join %>%
    group_by(year) %>%
    summarize(urchin_dev = mean(urchin_dev, na.rm=TRUE),
              mean_temp_dev = mean(mean_temp_dev, na.rm=TRUE),
              urchin = mean(urchin, na.rm = TRUE)) %>%
    arrange(year)


scenario <- crossing(DF_means, timeseries_df)


scenario_values <- predict(mod_urchin_add, 
                       newdata = scenario, 
                       re.form = NULL, 
                       type = "response",
                       se.fit = TRUE)

scenario <- scenario %>%
    mutate(kelp.perc = scenario_values$fit,
           lwr = kelp.perc - 1*scenario_values$se.fit,
           upr = kelp.perc + 1*scenario_values$se.fit,
           lwr = ifelse(lwr < 0, 0, lwr))




#york v. downeast
ggplot(scenario %>% 
           filter(region %in% c("downeast", "york")) %>%
           mutate(region = stringr::str_to_title(region)),
       aes(x = year,
           y = kelp.perc*100,
           group = region, 
           color = region)) +
    geom_line(size = 2) +
    geom_ribbon(aes(ymin = lwr*100, ymax = upr*100), alpha = 0.2, color = NA, fill = "grey") +
    scale_color_manual(values = c("blue", "red")) +
    theme_bw() +
    labs(color = "",
         x = "",
         y = "Percent Cover Kelp")
```


## Link Functions

While a complementary log-log plot makes sense in a system which experiences hysteresis, to be certain, we compared the additive model with a logit, probit, and cloglog link function. We find that the cloglog function clearly outperforms the others for this data set.

```{r compare_link}
mod_urchin_add_logit <- readRDS("derived_data/mod_urchin_add_logit.Rds")
mod_urchin_add_probit <- readRDS("derived_data/mod_urchin_add_probit.Rds")

AICtab(mod_urchin_add, mod_urchin_add_logit, mod_urchin_add_probit)
```
