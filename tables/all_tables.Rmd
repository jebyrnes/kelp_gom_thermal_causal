---
title: "Tables"
author: "Jarrett Byrnes"
output: officedown::rdocx_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, waning=FALSE, message=FALSE)
library(tidyverse)
library(car)
library(officer)
library(flextable)
library(broom)
library(broom.mixed)
library(glmmTMB)
library(gllvm)
library(betareg)


# functional helpers

chisq_anova_tab <- . %>%
    rename(p = p.value, `c2` = statistic) %>%
    mutate(p = formatC(p, format = "e", digits = 3),
           `c2` = round(`c2`, 3)) %>%
    qflextable() %>%
      compose(
        part = "header", j = "c2",
         value = as_paragraph("ùõò", as_sup("2")))

f_anova_tab <- . %>%
    rename(p = p.value, f = statistic) %>%
    mutate(p = formatC(p, format = "e", digits = 3),
           `f` = round(`f`, 3)) %>%
    qflextable() 
    
coef_t_tab <- . %>%
    rename(p = p.value, `t` = statistic,
           `std. error` = std.error) %>%
    mutate(p = formatC(p, format = "e", digits = 3),
           `t` = round(`t`, 3)) %>%
    qflextable() 

gllvm_chisq_anova_tab <- . %>%
    rename(p = P.value, `c2` = D, df = Df.diff) %>%
    mutate(p = formatC(p, format = "e", digits = 3),
           `c2` = round(`c2`, 3)) %>%
    qflextable() %>%
      compose(
        part = "header", j = "c2",
         value = as_paragraph("ùõò", as_sup("2")))

gllvm_chisq_anova_uni_tab <- . %>%
    rename(p = P.val, `c2` = D, df = Df.diff) %>%
  select(-Resid.Df) %>%
  select(species, everything()) %>%
  arrange(species, term) %>%
    mutate(p = formatC(p, format = "e", digits = 3),
           `c2` = round(`c2`, 3)) %>%
    qflextable() %>%
      compose(
        part = "header", j = "c2",
         value = as_paragraph("ùõò", as_sup("2")))

gllvm_posthoc_tab <- . %>%
    mutate(region = factor(region,
                            levels = rev(c("Downeast", "MDI", "Penobscot Bay",
                                           "Midcoast", "Casco Bay", "York")))) %>%
  rename(Species = name, Region = region) %>%
  arrange(Species, Region) %>%
  select(Species, everything()) %>%
  mutate(across(where(is.numeric), ~round(.x, 3))) %>%
  rename(`Mean Differerence from 2004 to 2018` = mean_diff_2004_to_2018,
         `Lower 95% CI` = lq,
         `Upper 95%CI` = uq) %>%
  qflextable()
```

# Main Paper Tables

## Kelp Drivers Model
```{r}
kelp_drivers_mod <- readRDS("model_output/mod_urchin_add.RDS")

Anova(kelp_drivers_mod) %>%
  tidy %>% 
  mutate(term  = 
           case_when(
             term == "urchin_anom_from_region" ~ "urchin anomaly",
             term == "mean_temp_spring_dev" ~ "spring temperature anomaly",
             term == "lag_mean_temp_summer_dev" ~ "lag summer temperature anomaly",
             term == "mean_regional_urchin" ~ "average urchins in subregion",
             term == "mean_mean_temp_spring" ~ "average spring temperature in subregion",
             term == "mean_mean_temp_summer" ~ "average lag summer temperature in subregion",
             TRUE ~ term)) %>%
  chisq_anova_tab
```


Table 1. $\chi^2$ likelihood ratio tests of drivers of kelp abundance across the outer coast of Maine.


```{r}
kelp_drivers_mod %>%
  tidy() %>%
  select(-effect, -component) %>%
  mutate(term = paste0(group, term),
         term = str_remove(term, "NA"),
         term = str_replace(term, "yearsd__\\(Intercept\\)", "year sd"),
         term = str_replace(term, "regionsd__\\(Intercept\\)", "region sd"),
         term  = 
           case_when(
             term == "urchin_anom_from_region" ~ "urchin anomaly",
             term == "mean_temp_spring_dev" ~ "spring temperature anomaly",
             term == "lag_mean_temp_summer_dev" ~ "lag summer temperature anomaly",
             term == "mean_regional_urchin" ~ "average urchins in subregion",
             term == "mean_mean_temp_spring" ~ "average spring temperature in subregion",
             term == "mean_mean_temp_summer" ~ "average lag summer temperature in subregion",
             TRUE ~ term),
         across(estimate:statistic, ~round(.x, 3)),
         p.value = formatC(p.value, format = "e", digits = 3)) %>%
  select(-group) %>%
  rename(SE = std.error,
         z = statistic,
         p = p.value) %>%
  mutate(p = ifelse(str_detect(p, "NA"), NA, p),
         term = gsub("[()]", "", term)) %>%
      qflextable() 
```
Table 2. Coefficient estimates, SE, and z tests for the kelp drivers model.



# Supplementary Tables


## Sample Sizes for Kelp Analysis

```{r}
source("scripts/2_load_combined_data.R")
combined_bio_temp_gmc %>%
    rename(Year = year, Region = region) %>%
    group_by(Year, Region) %>%
    summarize(`Sample Size` = length(unique(site))) %>%
    ungroup() %>%
    arrange(Region, Year) %>%
    qflextable() %>%
    colformat_num(big.mark = "")
```

Supplementary Table S1. Sample sizes of sites per region per year for use in the 5m kelp timeseries analysis and associated driver models.

## Kelp Timeseries Model at 10m
```{r}
kelp_ts_mod <- readRDS("model_output/kelp_timeseries_mod_10m.rds")

Anova(kelp_ts_mod) %>% tidy %>% chisq_anova_tab
```

Supplementary Table S2. $\chi^2$ likelihood ratio tests for trend analysis of kelp change over time at 10 m depth, in a model with an interaction. Note the interaction is not well supported. The logit coefficient of the relationship across all of Maine is `r round(coef(kelp_ts_mod)[2], 3)`.

## Sample Sizes for Composition Analysis

```{r}

comp_data <- read_csv("derived_data/compositional_change_data.csv") %>%
    mutate( region = factor(region,
                            levels = rev(c("Downeast", "MDI", "Penobscot Bay",
                                       "Midcoast", "Casco Bay", "York"))),
            year = factor(year, levels = c(2018, 2004)))

comp_data %>%
    rename(Year = year, Region = region) %>%
    group_by(Year, Region) %>%
    summarize(`Sample Size` = length(unique(site))) %>%
    ungroup() %>%
    arrange(Region, Year)%>%
    qflextable() %>%
    colformat_num(big.mark = "")
```

Supplementary Table S3. Sample sizes of sites per region per year for use in assessing changes in macroalgal community composition between 2004 and 2018.

## Kelp Timeseries Model
```{r}
kelp_ts_mod <- readRDS("model_output/kelp_timeseries_mod.rds")

Anova(kelp_ts_mod) %>% tidy %>% chisq_anova_tab
```

Supplementary Table S4. $\chi^2$ likelihood ratio tests for trend analysis of kelp change over time at 5 m depth.

## Temperature

```{r}
spring_ts_mod <- readRDS("model_output/spring_temp_timeseries.rds")

Anova(spring_ts_mod) %>% tidy %>% f_anova_tab
```

Supplementary Table S5. F Table results from spring temperature trend linear regression model.

```{r}

summary(spring_ts_mod) %>% tidy %>% coef_t_tab
```

Supplementary Table S6. Coefficient Table results from spring temperature trend linear regression model.

```{r}
summer_ts_mod <- readRDS("model_output/summer_temp_timeseries.rds")

Anova(summer_ts_mod) %>% tidy %>% f_anova_tab
```

Supplementary Table S7. F Table results from summer temperature trend linear regression model.

```{r}
summary(summer_ts_mod) %>% tidy %>% coef_t_tab
```
Supplementary Table S8. Coefficient Table results from summer temperature trend linear regression model.

## Kelp Composition Model
```{r}
read_csv("tables/kelp_gllvm_lrchisq.csv") %>%
  gllvm_chisq_anova_tab

```

Supplementary Table S9. $\chi^2$ likelihood ratio tests for trend analysis of kelp species composition over time.


```{r}
read_csv("tables/kelp_comp_gllvm_lrchisq.csv") %>%
  gllvm_chisq_anova_uni_tab

```

Supplementary Table S10. $\chi^2$ likelihood ratio tests for changes in individual kelp species  over time with p-values corrected for false discovery rate.

```{r}
read_csv("tables/kelp_change_posthoc_2004_2018.csv") %>%
  gllvm_posthoc_tab
```

Supplementary Table S11. Posthoc comparisons of differences in kelp species within each subregion between 2004 and 2018. Differences derived via simulation, and as such we include the 95% CI for each.

## Understory Composition Model

```{r}
read_csv("tables/understory_gllvm_lrchisq.csv") %>%
  gllvm_chisq_anova_tab

```

Supplementary Table S12. $\chi^2$ likelihood ratio tests for trend analysis of understory species composition over time.

```{r}
read_csv("tables/understory_comp_gllvm_lrchisq.csv") %>%
  gllvm_chisq_anova_uni_tab

```
Supplementary Table S13. $\chi^2$ likelihood ratio tests for changes in individual understory species  over time with p-values corrected for false discovery rate.

```{r}
read_csv("tables/understory_change_posthoc_2004_2018.csv") %>%
  gllvm_posthoc_tab
```

Supplementary Table S14. Posthoc comparisons of differences in understory species within each subregion between 2004 and 2018. Differences derived via simulation, and as such we include the 95% CI for each.

## Urchin Size Analysis

```{r}
read_csv("tables/urchin_size_trends.csv") |>
    qflextable()
```
Supplementary Table S15. Trends in urchin size by region over time.   
  
  
  
```{r}
read_csv("tables/urchin_size_trends_contrast.csv") |>
    qflextable()
```
Supplementary Table S16. Differences in trends in urchin sizes over time between regions. Only midcoast differs from any other regions. 